<!DOCTYPE html>
<html>
    <head>
        <title>Pocotó Walker</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <style>

            #tabuleiro {
                margin: 0 auto;
            }

            #tabuleiro td {
                width: 55px;
                height: 55px;
                border: 1px solid #000;
                text-align: center;
                vertical-align: middle;
                cursor: pointer;
            }

        </style>

    </head>
    <body>
        <table id="tabuleiro"></table>

        <script src="./jquery-2.2.4.min.js"></script>
        <script src="./Nodo.js"></script>

        <script>

            $(document).ready(function () {

                var origem = null;

                var linhas = 8;
                var colunas = 8;

                var vertices = [];

                for (var i = 0; i < linhas; i++) {

                    $('#tabuleiro').append('<tr id="linha_' + i + '"></tr>');

                    for (var j = 0; j < colunas; j++) {

                        var nodo = new Nodo(i, j);

                        var possibilidades = getPossibilidades(nodo.linha, nodo.coluna);

                        for (var p = 0; p < possibilidades.length; p++) {
                            nodo.possibilidades.push(possibilidades[p][0] * colunas + possibilidades[p][1]);
                            nodo.possibilidadesVisitadas.push(false);
                        }

                        vertices[i * colunas + j] = nodo;

                        $('#tabuleiro #linha_' + i).append('<td id="coluna_' + j + '" ' + (((i + j) % 2 === 0) ? '' : 'style="background: #CCC;"') + ' data-linha="' + i + '" data-coluna="' + j + '" data-vertice="' + (i * colunas + j) + '" ><span></span></td>');
                    }

                }

                console.log(vertices);

                function getPossibilidades(linha_origem, coluna_origem) {

                    var possibilidades = [];

                    for (var i = 1; i <= 2; i++) {
                        for (var j = 1; j <= 2; j++) {

                            if (i !== j) {

                                if (linha_origem + i < linhas && coluna_origem + j < colunas) {
                                    possibilidades.push([linha_origem + i, coluna_origem + j]);
                                }

                                if (linha_origem + i < linhas && coluna_origem - j >= 0) {
                                    possibilidades.push([linha_origem + i, coluna_origem - j]);
                                }

                                if (linha_origem - i >= 0 && coluna_origem + j < colunas) {
                                    possibilidades.push([linha_origem - i, coluna_origem + j]);
                                }

                                if (linha_origem - i >= 0 && coluna_origem - j >= 0) {
                                    possibilidades.push([linha_origem - i, coluna_origem - j]);
                                }

                            }

                        }
                    }

                    return possibilidades;
                }

                var passos = 1;

                $('td').on('click', function () {

                    origem = this;

                    passos = 1;

                    for (var i = 0; i < vertices.length; i++) {
                        vertices[i].visitado = false;
                        vertices[i].anterior = -1;
                        
                        $('tr#linha_' + vertices[i].linha + ' td#coluna_' + vertices[i].coluna + ' span').text('');

                        for (var p = 0; p < vertices[i].possibilidades.length; p++) {
                            vertices[i].possibilidadesVisitadas[p] = false;
                        }
                    }

                    pathfinding();
                });

                function pathfinding() {

                    var nodo = vertices[$(origem).data('linha') * colunas + $(origem).data('coluna')];

                    nodo.visitado = true;

                    nodo = pathfindingLoop(nodo);

                    printPosicoes(nodo);
                }

                function pathfindingLoop(nodo) {

                    if (passos === linhas * colunas) {
                        console.log('passos = ' + (linhas * colunas));
                        return nodo;
                    }

                    var melhorNo = null;

                    // Verifica quantos caminhos estão disponíveis
                    var disponiveis = getDisponiveis(nodo);

                    if (disponiveis === 0) {
                        console.log('disponiveis = 0');
                        alert('fudeu?');
                        return nodo;
                    }

                    // Pega melhor nó do nó atual
                    for (var i = 0; i < nodo.possibilidades.length; i++) {

                        var proximoNo = vertices[nodo.possibilidades[i]];

                        // Seta o nó atual como visitado no proximo nó
                        proximoNo.possibilidadesVisitadas[proximoNo.possibilidades.indexOf(nodo.linha * colunas + nodo.coluna)] = true;

                        if (!proximoNo.visitado) {
                            if (melhorNo === null || getDisponiveis(melhorNo) > getDisponiveis(proximoNo)) {
                                melhorNo = proximoNo;
                            }
                        }
                    }

                    if (melhorNo === null) {
                        alert('melhorNo = null');
                        return null;
                    }

                    nodo.possibilidadesVisitadas[nodo.possibilidades.indexOf(melhorNo.linha * colunas + melhorNo.coluna)] = true;
                    melhorNo.visitado = true;
                    melhorNo.anterior = nodo.linha * colunas + nodo.coluna;

                    passos++;

                    return pathfindingLoop(melhorNo);
                }

                function printPosicoes(nodo) {

                    console.log('printa');
                    console.log(nodo);

                    while (nodo !== null && passos > 0) {

                        $('tr#linha_' + nodo.linha + ' td#coluna_' + nodo.coluna + ' span').text(passos);
                        passos--;
                        
                        nodo = vertices[nodo.anterior];
                    }
                }

                // Verifica quantos caminhos estão disponíveis
                function getDisponiveis(nodo) {
                    var disponiveis = 0;

                    for (var i = 0; i < nodo.possibilidades.length; i++) {
                        if (!nodo.possibilidadesVisitadas[i]) {
                            disponiveis++;
                        }
                    }

                    return disponiveis;
                }

            });

        </script>
    </body>
</html>
